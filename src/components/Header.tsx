import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { ShoppingCart, User, Menu, Search, Heart, X, ChevronDown, ChevronRight, LogOut } from 'lucide-react';
import { useStore } from '../store/useStore';
import { useAuth } from '@/contexts/AuthContext';
import { motion, AnimatePresence, useScroll, useTransform } from 'framer-motion';

import {
  DropdownMenu as MobileDropdown,
  DropdownMenuContent as MobileDropdownContent,
  DropdownMenuItem as MobileDropdownItem,
  DropdownMenuTrigger as MobileDropdownTrigger,
} from '@/components/ui/dropdown-menu';
import SearchSidebar from './SearchSidebar';
import { supabase } from '@/integrations/supabase/client';
// logo import removed
const logo = "/jabbrr_logo.png";

interface HeaderProps {
  isAdminRoute?: boolean;
  isKitchenRoute?: boolean;
}

const Header: React.FC<HeaderProps> = ({ isAdminRoute = false, isKitchenRoute = false }) => {
  if (isAdminRoute || isKitchenRoute) return null;

  const navigate = useNavigate();
  const { cartItems, toggleCart } = useStore();
  const { user, signOut, isAdmin } = useAuth();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isSearchOpen, setIsSearchOpen] = useState(false);

  // Dynamic Data States
  const [categories, setCategories] = useState<any[]>([]);
  const [collections, setCollections] = useState<any[]>([]);

  // Scroll handling
  const { scrollY } = useScroll();
  const headerHeight = useTransform(scrollY, [0, 100], ["auto", "auto"]);

  // Logo scale animation
  const logoScale = useTransform(scrollY, [0, 100], [1, 0.9]);

  const [isScrolled, setIsScrolled] = useState(false);

  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 20);
    };
    window.addEventListener('scroll', handleScroll);
    fetchNavigationData();
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const fetchNavigationData = async () => {
    try {
      // 1. Fetch Categories
      const { data: catData } = await supabase
        .from('categories')
        .select('*')
        .eq('is_active', true)
        .order('name');
      if (catData) setCategories(catData);

      // 2. Mock Collections (Adapted for Jabbrr Afghani)
      const mockCollections = [
        { id: 'c1', name: "New Arrivals", slug: 'new-arrivals' },
        { id: 'c2', name: "Bestsellers", slug: 'bestsellers' }
      ];
      setCollections(mockCollections);
    } catch (error) {
      console.error("Error fetching nav data:", error);
    }
  };

  const cartItemsCount = cartItems.reduce((total, item) => total + item.quantity, 0);

  // Desktop Hover Dropdown Component
  const DesktopNavDropdown = ({ title, items, onSelect }: { title: string, items: any[], onSelect: (slug: string) => void }) => {
    return (
      <div className="relative group px-1 h-full flex items-center cursor-pointer">
        <button className="flex items-center gap-0.5 lg:gap-1 text-[10px] lg:text-xs font-kugile font-normal tracking-[0.15em] uppercase text-foreground group-hover:text-primary transition-colors outline-none bg-transparent border-none p-0">
          {title} <ChevronDown className="w-4 h-4 transition-transform duration-300 group-hover:rotate-180" />
        </button>

        {/* Dropdown Content - Show on hover */}
        <div className="absolute top-full left-0 pt-4 hidden group-hover:block w-64 animate-in fade-in slide-in-from-top-2 duration-200 z-50">
          <div className="bg-background border border-border shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-sm py-2 relative">
            {/* Arrow pointer */}
            <div className="absolute -top-2 left-6 w-4 h-4 bg-background border-t border-l border-border rotate-45"></div>

            {items.map((item, idx) => (
              <div
                key={idx}
                onClick={() => onSelect(item.slug || item.name)}
                className="px-6 py-3 text-xs font-kugile font-normal tracking-widest text-muted-foreground hover:text-primary hover:bg-primary/10 transition-colors uppercase cursor-pointer relative z-10"
              >
                {item.name}
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  const MobileMenuItem = ({ label, path, onClick, subItems }: { label: string; path?: string; onClick?: () => void, subItems?: any[] }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    return (
      <div className="border-b border-border last:border-0 bg-background bg-opacity-100">
        <button
          onClick={() => {
            if (subItems && subItems.length > 0) setIsExpanded(!isExpanded);
            else {
              if (path) navigate(path);
              if (onClick) onClick();
              setIsMobileMenuOpen(false);
            }
          }}
          className="flex items-center justify-between w-full py-5 px-6 text-left group"
        >
          <span className={`text-sm font-kugile font-normal tracking-widest uppercase transition-colors ${isExpanded ? 'text-primary' : 'text-foreground'}`}>
            {label}
          </span>
          {subItems && subItems.length > 0 ? (
            <ChevronDown className={`w-5 h-5 text-muted-foreground transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
          ) : (
            <ChevronRight className="w-5 h-5 text-muted-foreground opacity-60 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
          )}
        </button>
        <AnimatePresence>
          {isExpanded && subItems && (
            <motion.div
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: 'auto', opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              className="overflow-hidden bg-primary/10"
            >
              {subItems.map((sub, idx) => (
                <button
                  key={idx}
                  onClick={() => {
                    navigate(`/menu?category=${sub.slug || sub.name}`);
                    setIsMobileMenuOpen(false);
                  }}
                  className="block w-full text-left py-4 px-10 text-xs font-kugile font-normal tracking-widest uppercase text-muted-foreground hover:text-primary border-b border-border last:border-0"
                >
                  {sub.name}
                </button>
              ))}
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    );
  };

  return (
    <>
      <motion.header
        className={`bg-background sticky top-0 z-40 transition-all duration-500 border-b border-border ${isScrolled ? 'shadow-lg py-1' : 'py-3'}`}
        style={{ height: headerHeight }}
      >
        <div className="container mx-auto px-4 lg:px-8">
          <div className="flex justify-between items-center h-20 lg:h-24 relative">

            {/* LEFT: Logo */}
            <div className="flex-shrink-0 relative z-10 group mr-8">
              <Link to="/">
                <motion.img
                  src={logo}
                  alt="Jabbrr Afghani"
                  className="h-16 md:h-20 lg:h-24 w-auto object-contain transition-transform duration-500 group-hover:scale-105 drop-shadow-sm"
                  style={{ scale: logoScale }}
                />
              </Link>
            </div>

            {/* CENTER: Navigation (Desktop) */}
            <nav className="hidden lg:flex items-center gap-4 lg:gap-8 xl:gap-10 flex-1 justify-center">
              {/* New Arrivals - Mapped to Sort */}
              <Link
                to="/menu?sort=newest"
                className="relative group px-0.5 lg:px-1 py-1"
              >
                <span className="text-[10px] lg:text-xs font-kugile font-normal tracking-[0.15em] uppercase text-foreground group-hover:text-primary transition-colors">
                  New Arrivals
                </span>
                <span className="absolute bottom-0 left-1/2 w-0 h-[1px] bg-primary transition-all duration-500 ease-out -translate-x-1/2 group-hover:w-full" />
              </Link>

              {/* Bestsellers - Mapped to Sort */}
              <Link
                to="/menu?sort=bestseller"
                className="relative group px-0.5 lg:px-1 py-1"
              >
                <span className="text-[10px] lg:text-xs font-kugile font-normal tracking-[0.15em] uppercase text-foreground group-hover:text-primary transition-colors">
                  Bestsellers
                </span>
                <span className="absolute bottom-0 left-1/2 w-0 h-[1px] bg-primary transition-all duration-500 ease-out -translate-x-1/2 group-hover:w-full" />
              </Link>

              {/* Gifting Dropdown */}


              {/* Categories Dropdown */}
              <DesktopNavDropdown
                title="Category"
                items={categories}
                onSelect={(slug) => navigate(`/menu?category=${slug}`)}
              />
            </nav>

            {/* ... Right Actions ... */}
            <div className="flex items-center gap-4 lg:gap-6 justify-end">
              {/* Search */}
              <motion.button
                whileHover={{ scale: 1.05 }}
                onClick={() => setIsSearchOpen(true)}
                className="text-foreground hover:text-primary transition-colors flex items-center gap-2 group"
              >
                <Search className="w-5 h-5 lg:w-6 lg:h-6 stroke-[1.5px]" />
              </motion.button>

              <div className="h-6 w-[1px] bg-border hidden md:block"></div>

              {/* Heart */}
              <motion.button className="hidden md:block text-foreground hover:text-primary transition-colors">
                <Heart className="w-5 h-5 lg:w-6 lg:h-6 stroke-[1.5px]" />
              </motion.button>

              {/* User */}
              {user ? (
                <MobileDropdown>
                  <MobileDropdownTrigger className="outline-none">
                    <motion.div whileHover={{ scale: 1.05 }} className="text-foreground hover:text-primary transition-colors hidden md:block cursor-pointer">
                      <User className="w-5 h-5 lg:w-6 lg:h-6 stroke-[1.5px]" />
                    </motion.div>
                    <div className="md:hidden text-foreground">
                      <User className="w-6 h-6 stroke-[1.5px]" onClick={() => navigate('/profile')} />
                    </div>
                  </MobileDropdownTrigger>
                  <MobileDropdownContent align="end" className="hidden md:block w-64 bg-background border border-border shadow-xl rounded-sm p-2 z-[60]">
                    {isAdmin && (
                      <MobileDropdownItem className="focus:bg-primary/20 text-foreground cursor-pointer font-kugile font-normal tracking-wide text-xs uppercase py-3" onClick={() => navigate('/admin')}>
                        Admin Dashboard
                      </MobileDropdownItem>
                    )}
                    <MobileDropdownItem className="focus:bg-primary/20 text-foreground cursor-pointer font-kugile font-normal tracking-wide text-xs uppercase py-3" onClick={() => navigate('/profile')}>
                      Profile
                    </MobileDropdownItem>
                    <MobileDropdownItem className="focus:bg-primary/20 text-foreground cursor-pointer font-kugile font-normal tracking-wide text-xs uppercase py-3" onClick={signOut}>
                      Sign Out
                    </MobileDropdownItem>
                  </MobileDropdownContent>
                </MobileDropdown>
              ) : (
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  onClick={() => navigate('/auth')}
                  className="text-foreground hover:text-primary transition-colors hidden md:block"
                >
                  <User className="w-5 h-5 lg:w-6 lg:h-6 stroke-[1.5px]" />
                </motion.button>
              )}

              {/* Cart */}
              <motion.button
                whileHover={{ scale: 1.05 }}
                onClick={toggleCart}
                className="relative text-foreground hover:text-primary transition-colors p-1"
              >
                <ShoppingCart className="w-5 h-5 lg:w-6 lg:h-6 stroke-[1.5px]" />
                {cartItemsCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-primary text-white text-xs w-4 h-4 rounded-full flex items-center justify-center shadow-sm font-kugile font-normal">
                    {cartItemsCount}
                  </span>
                )}
              </motion.button>

              {/* Mobile Menu Toggle */}
              <div className="lg:hidden ml-2">
                <button onClick={() => setIsMobileMenuOpen(true)} className="text-foreground hover:text-primary transition-colors">
                  <Menu className="w-7 h-7 stroke-[1.5px]" />
                </button>
              </div>
            </div>
          </div>
        </div>
      </motion.header>

      {/* Mobile Menu */}
      <AnimatePresence>
        {isMobileMenuOpen && (
          <>
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsMobileMenuOpen(false)}
              className="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 lg:hidden"
            />
            <motion.div
              initial={{ x: '-100%' }}
              animate={{ x: 0 }}
              exit={{ x: '-100%' }}
              transition={{ type: "tween", duration: 0.4, ease: [0.32, 0.72, 0, 1] }}
              className="fixed top-0 left-0 bottom-0 w-[85%] max-w-[320px] bg-background z-50 shadow-2xl overflow-y-auto border-r border-border"
            >
              <div className="p-6 flex items-center justify-between border-b border-border bg-background">
                <img src={logo} alt="Jabbrr Afghani" className="h-20 w-auto object-contain" />
                <button onClick={() => setIsMobileMenuOpen(false)} className="p-2 text-foreground hover:bg-white/5 rounded-full">
                  <X className="w-7 h-7" />
                </button>
              </div>

              <div className="py-2">
                {/* Manual Links for Collections */}
                <MobileMenuItem
                  label="New Arrivals"
                  path="/menu?sort=newest"
                />
                <MobileMenuItem
                  label="Bestsellers"
                  path="/menu?sort=bestseller"
                />


                <MobileMenuItem
                  label="All Categories"
                  subItems={categories.map(c => ({ name: c.name, slug: c.name }))}
                />

                {user ? (
                  <div className="mt-8 px-6 pt-6 border-t border-border">
                    <button onClick={() => { navigate('/profile'); setIsMobileMenuOpen(false); }} className="flex items-center space-x-3 w-full py-3 text-foreground font-kugile font-normal tracking-widest text-xs uppercase hover:text-primary">
                      <User className="w-4 h-4" /> <span>Profile</span>
                    </button>
                    {isAdmin && (
                      <button onClick={() => { navigate('/admin'); setIsMobileMenuOpen(false); }} className="flex items-center space-x-3 w-full py-3 text-primary font-kugile font-normal tracking-widest text-xs uppercase hover:text-primary/90">
                        <User className="w-4 h-4" /> <span>Admin</span>
                      </button>
                    )}
                    <button onClick={() => { signOut(); setIsMobileMenuOpen(false); }} className="flex items-center space-x-3 w-full py-3 text-muted-foreground font-kugile font-normal tracking-widest text-xs uppercase hover:text-primary">
                      <LogOut className="w-4 h-4" /> <span>Log Out</span>
                    </button>
                  </div>
                ) : (
                  <div className="p-6 mt-4">
                    <button
                      onClick={() => { navigate('/auth'); setIsMobileMenuOpen(false); }}
                      className="w-full bg-primary text-white py-4 rounded-sm uppercase tracking-[0.2em] font-kugile font-normal text-xs hover:bg-primary/90 transition-colors shadow-lg"
                    >
                      Login / Sign Up
                    </button>
                  </div>
                )}
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>

      <SearchSidebar isOpen={isSearchOpen} onClose={() => setIsSearchOpen(false)} />
    </>
  );
};

export default Header;
